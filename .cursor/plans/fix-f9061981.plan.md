<!-- f9061981-7edc-4cf4-8bd2-a790caf054eb 0104a8b1-745b-45a2-bd30-3633e013a444 -->
# Fix Dentist Creation Auth Error

## Problem Analysis

The error `AuthApiError` with code `unexpected_failure` (status 500) occurs when calling `supabase.auth.admin.createUser()`. This typically indicates:

1. **Service role key issue**: Invalid, expired, or missing admin permissions
2. **Supabase project configuration**: Auth settings or project restrictions
3. **Network/connection issue**: Backend can't reach Supabase Auth API
4. **Key format issue**: Using anon key instead of service role key

## Implementation Steps

### 1. Enhance Error Handling for Auth Errors

**File**: `backend/src/services/admin.service.ts`

- Add specific handling for `unexpected_failure` code
- Log full error object including all properties
- Check if error is related to service role key (401, 403, or JWT-related messages)
- Provide actionable error messages to help diagnose the issue

**Changes**:

- Catch `unexpected_failure` specifically and provide diagnostic information
- Log the full error object structure for debugging
- Check error status codes (401/403 suggest auth issues)
- Verify service role key format (should start with `eyJ`)

### 2. Add Service Role Key Validation on Startup

**File**: `backend/src/config/supabase.ts`

- Enhance `testAdminPermissions()` to also test `createUser` capability
- Add validation to check service role key format
- Log warnings if key format looks incorrect (e.g., starts with `sb_` which is publishable key)

**Changes**:

- Add `testCreateUserCapability()` function that attempts to create a test user (then delete it)
- Validate key format: service role keys start with `eyJ`, not `sb_`
- Log clear warnings if key format is suspicious

### 3. Improve Error Messages in Frontend

**File**: `admin-app/src/pages/AddDoctor.tsx`

- Display more specific error messages based on error type
- Show actionable guidance when service role key issues are detected
- Add a help link or instructions for fixing configuration

**Changes**:

- Parse error messages to detect service role key issues
- Show user-friendly messages with next steps
- Display backend error details in development mode

### 4. Add Diagnostic Endpoint

**File**: `backend/src/routes/admin.routes.ts` and `backend/src/controllers/admin.controller.ts`

- Create `/admin/diagnostics` endpoint to test Supabase configuration
- Test service role key permissions
- Verify database connectivity
- Return detailed diagnostic information

**Changes**:

- Add `getDiagnostics` method in `AdminController`
- Test: service role key format, admin permissions, createUser capability
- Return JSON with diagnostic results and recommendations

### 5. Add Pre-Creation Validation

**File**: `backend/src/services/admin.service.ts`

- Before attempting to create user, verify service role key has createUser permission
- If validation fails, return clear error message immediately
- Log diagnostic information for troubleshooting

**Changes**:

- Call `testAdminPermissions()` or similar check before `createUser`
- If check fails, throw descriptive error about service role key configuration
- Include instructions in error message

### 6. Verify Environment Configuration

**File**: `backend/src/config/env.ts`

- Add validation to ensure service role key format is correct
- Warn if key looks like anon key or publishable key
- Provide clear error messages if key format is wrong

**Changes**:

- Add format validation for `SUPABASE_SERVICE_ROLE_KEY`
- Check that key starts with `eyJ` (JWT format)
- Warn if key starts with `sb_` (publishable key format)

## Expected Outcome

After implementation:

1. **Better error messages**: Users will see specific, actionable error messages instead of generic "Database error"
2. **Startup validation**: Backend will warn immediately if service role key is misconfigured
3. **Diagnostic tools**: Admin can check Supabase configuration via diagnostic endpoint
4. **Pre-creation checks**: System validates permissions before attempting user creation
5. **Clear guidance**: Error messages include steps to fix the issue

## Testing

1. Test with invalid service role key → Should show clear error
2. Test with anon key instead of service role key → Should detect and warn
3. Test with correct service role key → Should create dentist successfully
4. Test diagnostic endpoint → Should return configuration status
5. Test error handling → Should provide actionable error messages

## Files to Modify

1. `backend/src/services/admin.service.ts` - Enhanced error handling
2. `backend/src/config/supabase.ts` - Service role key validation
3. `backend/src/config/env.ts` - Key format validation
4. `backend/src/controllers/admin.controller.ts` - Diagnostic endpoint
5. `backend/src/routes/admin.routes.ts` - Add diagnostic route
6. `admin-app/src/pages/AddDoctor.tsx` - Better error display